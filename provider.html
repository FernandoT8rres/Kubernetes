<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Proveedores</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/sweetalert2.css">
	<link rel="stylesheet" href="css/material.min.css">
	<link rel="stylesheet" href="css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
	<link rel="stylesheet" href="css/main.css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="js/material.min.js"></script>
	<script src="js/sweetalert2.min.js"></script>
	<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="js/main.js"></script>
	<style>
		.center-icon {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		body {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			min-height: 100vh;
			font-family: Arial, sans-serif;
		}

		section {
			width: 100%;
			max-width: 1200px;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			align-items: center;
			padding: 20px;
			text-align: center;
		}

		.tile {
			width: calc(33.333% - 20px);
			margin: 10px;
			padding: 20px;
			background-color: #f4f4f4;
			border-radius: 8px;
			box-shadow: 0 2px 5px rgb(77, 184, 106);
			transition: transform 0.3s ease;
			cursor: pointer;
		}

		.tile:hover {
			transform: translateY(-5px);
			box-shadow: 0 5px 15px rgb(77, 184, 106);
		}

		.tile i {
			font-size: 48px;
			margin-bottom: 10px;
			color: #4CAF50;
		}

		.tile-text {
			font-size: 14px;
		}

		.tile-text small {
			font-size: 12px;
			color: #666;
		}

		/* Responsive styles */
		@media (max-width: 768px) {
			nav ul {
				flex-direction: column;
			}

			section {
				flex-direction: column;
			}

			.tile {
				width: 90%;
			}
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		header {
			background-color: white;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 10px;
		}

		nav {
			display: grid;
			flex-wrap: wrap;
			justify-content: center;
			align-items: center;
			text-align: center;
			align-content: center;
			padding: 10px 20px;
		}

		nav ul {
			list-style: none;
			display: flex;
			flex-wrap: wrap;
			margin: 0;
			padding: 0;
			transition: all .3s ease-in-out;
			border-radius: 5px;
		}

		nav ul li {
			position: relative;
			margin: 0 10px;
		}

		nav ul li a {
			text-decoration: none;
			color: black;
			padding: 10px 15px;
			display: flex;
			align-items: center;
			gap: 10px;
			position: relative;
			transition: all 0.3s ease;
		}

		nav ul li a:hover {
			background-color: rgba(40, 167, 69, 0.1);
			color: #28a745;
			border-radius: 5px;
			transform: translateX(5px);
		}

		nav ul li a span {
			display: block;
			height: 100%;
			width: 100%;
			left: 0;
			position: absolute;
			top: -55px;
			z-index: -1;
			transition: all 0.3s ease;
		}

		nav ul li:hover>ul {
			display: block;
		}

		nav ul li ul {
			display: none;
			position: absolute;
			top: 100%;
			left: 0;
			background-color: #000000;
			padding: 0;
			margin: 0;
			width: 200px;
			z-index: 10;
		}

		nav ul li ul li {
			text-align: left;
		}

		nav ul li ul li a {
			padding: 10px 15px;
			color: black;
			text-align: left;
			display: flex;
			gap: 10px;
		}

		nav ul li ul li a:hover {
			background-color: rgba(40, 167, 69, 0.1);
			color: #28a745;
			transform: translateX(5px);
		}

		nav ul li ul {
			display: none;
			position: absolute;
			top: 100%;
			left: 50%;
			transform: translateX(-50%);
			background-color: white;
			padding: 10px 0;
			margin: 0;
			width: 240px;
			text-align: center;
			z-index: 10;
		}

		nav ul li:hover>ul {
			display: block;
		}

		nav ul li ul li a {
			padding: 10px 20px;
			color: black;
			text-align: center;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		nav ul li ul li a:hover {
			background-color: rgba(40, 167, 69, 0.1);
			color: #28a745;
			border-radius: 5px;
			transform: translateX(5px);
		}

		.user-info {
			color: black;
			margin-top: auto;
			padding: 10px 15px;
		}

		@media (max-width: 768px) {
			nav ul li ul {
				width: 100%;
				left: 0;
				transform: none;
			}
		}


		/* Responsive styles */
		@media (max-width: 768px) {
			nav ul {
				flex-direction: column;
				width: 100%;
			}

			nav ul li {
				width: 100%;
				text-align: center;
			}

			nav ul li ul {
				position: static;
			}
		}

		.logo {
			display: flex;
			height: 200px;
			margin-right: 15px;
		}

		/* Botón hamburguesa */
		.menu-toggle {
			display: none;
			background: none;
			border: none;
			font-size: 28px;
			cursor: pointer;
			position: fixed;
			left: 20px;
			top: 20px;
			z-index: 20;
			color: #333;
		}

		/* Menú desplegable en dispositivos móviles */
		@media (max-width: 768px) {
			.menu-toggle {
				display: block;
			}

			nav {
				position: fixed;
				top: 0;
				left: -100%;
				width: 300px;
				height: 100%;
				background-color: white;
				box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
				transition: transform 0.4s ease, left 0.4s ease;
				z-index: 15;
			}

			nav.open {
				left: 0;
				transform: translateX(0);
			}

			.user-info {
				padding: 20px;
				font-size: 16px;
				font-weight: 600;
				color: #666;
				background-color: #f9f9f9;
				border-bottom: 1px solid #eaeaea;
			}

			nav ul {
				flex-direction: column;
				padding: 0;
				margin: 0;
				list-style: none;
				width: 100%;
			}

			nav ul li {
				width: 100%;
				text-align: left;
			}

			nav ul li a {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 15px 20px;
				font-size: 16px;
				font-weight: 500;
				color: #333;
				text-decoration: none;
				border-bottom: 1px solid #eaeaea;
				transition: background-color 0.3s ease, transform 0.3s ease;
			}

			nav ul li a:hover {
				background-color: rgba(40, 167, 69, 0.1);
				color: #28a745;
				transform: translateX(5px);
			}

			nav ul li ul {
				display: none;
				padding-left: 20px;
				background-color: white;
			}

			nav ul li:hover>ul {
				display: block;
			}

			nav ul li ul li a {
				padding: 10px 20px;
				font-size: 14px;
				color: #555;
			}

			nav ul li ul li a:hover {
				background-color: rgba(40, 167, 69, 0.1);
				color: #28a745;
			}
		}

		/* Estilos para la tabla de proveedores */
		.provider-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		.provider-table th,
		.provider-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}

		.provider-table th {
			background-color: #4CAF50;
			color: white;
		}

		.provider-table tr:nth-child(even) {
			background-color: #f2f2f2;
		}

		.provider-table tr:hover {
			background-color: #ddd;
		}

		.action-buttons button {
			margin: 2px;
			padding: 5px 10px;
			border: none;
			border-radius: 3px;
			cursor: pointer;
		}

		.edit-btn {
			background-color: #2196F3;
			color: white;
		}

		.delete-btn {
			background-color: #f44336;
			color: white;
		}
	</style>
<head>
<body>
    <header>
        <div class="logo">
            <img src="assets/img/cfe-logo.png" alt="logo">
        </div>
        <button class="menu-toggle" id="menuToggle">
            <i class="zmdi zmdi-menu"></i>
        </button>
        <nav id="mainNav">
            <div class="user-info">
                <span>Bienvenido: <strong id="loggedUser">Cargando...</strong></span>
            </div>
            <ul>
                <li><a href="home.html"><i class="zmdi zmdi-view-dashboard"></i>Inicio</a></li>
                <li>
                    <a href="#"><i class="zmdi zmdi-case"></i>Administración</a>
                    <ul>
                        <li><a href="providers.html"><i class="zmdi zmdi-truck"></i>Generar Entrada</a></li>
                        <li><a href="sales.html"><i class="zmdi zmdi-shopping-cart"></i>Entradas</a></li>
                        <li><a href="generate.html"><i class="zmdi zmdi-comment-edit"></i>Generar Salida</a></li>
                        <li><a href="exits.html"><i class="zmdi zmdi-square-right"></i>Salidas</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="zmdi zmdi-local-store"></i>Almacén</a>
                    <ul>
                        <li><a href="inventory.html"><i class="zmdi zmdi-local-store"></i>Ver Almacén</a></li>
                        <li><a href="products.html"><i class="zmdi zmdi-plus-circle"></i>Registrar Producto</a>
                        </li>
                        <li><a href="edit.html"><i class="zmdi zmdi-edit"></i>Editar Producto</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="zmdi zmdi-face"></i>Usuario</a>
                    <ul>
                        <li><a href="admin.html"><i class="zmdi zmdi-account-o"></i>Administrador</a></li>
                        <li><a href="provider.html"><i class="zmdi zmdi-accounts-add"></i>Proveedores</a></li>
                        <li><a href="dispatcher.html"><i class="zmdi zmdi-accounts-outline"></i>Despachadores</a>
                        </li>
                        <li><a href="client.html"><i class="zmdi zmdi-accounts-alt"></i>Clientes</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="zmdi zmdi-wrench"></i>Ajustes</a>
                    <ul>
                        <li><a href="history.html"><i class="zmdi zmdi-time-restore"></i>Historial</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>
    <section class="full-width header-well">
        <div class="center-icon header-well-icon">
            <i class="zmdi zmdi-account"></i>
        </div>
        <div class="full-width header-well-text">
            <p class="text-condensedLight"></p>
        </div>
    </section>

    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
        <div class="mdl-tabs__tab-bar">
            <a href="#tabNewAdmin" class="mdl-tabs__tab is-active">Nuevo</a>
            <a href="#tabListAdmin" class="mdl-tabs__tab">Registrados</a>
        </div>

        <div class="mdl-tabs__panel is-active" id="tabNewAdmin">
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--12-col">
                    <div class="full-width panel mdl-shadow--2dp">
                        <div class="full-width panel-tittle bg-primary text-center tittles">Nuevo Proveedor</div>
                        <div class="full-width panel-content">
                            <form id="provider-form">
                                <input type="hidden" id="id" value="">
                                <div class="mdl-grid">
                                    <div class="mdl-cell mdl-cell--6-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="nombre" required>
                                            <label class="mdl-textfield__label" for="nombre">Nombre</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--6-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="direccion" required>
                                            <label class="mdl-textfield__label" for="direccion">Dirección</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="cp" required>
                                            <label class="mdl-textfield__label" for="cp">CP</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="poblacion" required>
                                            <label class="mdl-textfield__label" for="poblacion">Ciudad</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="provincia" required>
                                            <label class="mdl-textfield__label" for="provincia">Provincia</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="nif" required>
                                            <label class="mdl-textfield__label" for="nif">NIF</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="telefono" required>
                                            <label class="mdl-textfield__label" for="telefono">Teléfono</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="fax">
                                            <label class="mdl-textfield__label" for="fax">Fax</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="text" id="www">
                                            <label class="mdl-textfield__label" for="www">Página Web</label>
                                        </div>
                                    </div>
                                    <div class="mdl-cell mdl-cell--4-col">
                                        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                            <input class="mdl-textfield__input" type="email" id="correo_e" required>
                                            <label class="mdl-textfield__label" for="correo_e">Correo
                                                Electrónico</label>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-center">
                                    <button type="submit"
                                        class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored bg-primary">
                                        <i class="zmdi zmdi-plus"></i>
                                    </button>
                                <div class="mdl-tooltip" for="btn-addAdmin">Agregar Proveedor</div>
                                </p>
                                <p id="successMessage" style="display:none;color:green;">Proveedor registrado con éxito!
                                </p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mdl-tabs__panel" id="tabListAdmin">
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--12-col">
                    <div class="full-width panel mdl-shadow--2dp">
                        <div class="full-width panel-tittle bg-success text-center tittles">Lista de Proveedores
                        </div>
                        <div class="full-width panel-content" id="provider-list">
                            <table class="provider-table" id="provider-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los proveedores se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </section>

</body>
<script>
    // Verificar si el usuario está autenticado
    document.addEventListener("DOMContentLoaded", function () {
        // Obtener el nombre del usuario del almacenamiento local
        const userFullName = localStorage.getItem("loggedInUser");
        if (!userFullName) {
            // Si no hay usuario autenticado, redirigir al login
            window.location.href = "index.html";
        } else {
            document.getElementById("loggedUser").innerText = userFullName;
        }

        // Inicializar el menú móvil
        const menuToggle = document.getElementById("menuToggle");
        const mainNav = document.getElementById("mainNav");

        menuToggle.addEventListener("click", function () {
            mainNav.classList.toggle("open");
        });

        document.addEventListener("click", function (event) {
            if (!mainNav.contains(event.target) && !menuToggle.contains(event.target)) {
                mainNav.classList.remove("open");
            }
        });

        // Cargar la lista de proveedores al iniciar
        cargarProveedores();
    });

    // Función para cargar todos los proveedores
    function cargarProveedores() {
        fetch('load_providers.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.querySelector('#provider-table tbody');
                tbody.innerHTML = '';

                data.forEach(proveedor => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${proveedor.nombre}</td>
                        <td>${proveedor.correo_e}</td>
                        <td>${proveedor.telefono}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" onclick='editarProveedor(${JSON.stringify(proveedor).replace(/'/g, "&#39;")})'>
                                <i class="zmdi zmdi-edit"></i> Editar
                            </button>
                            <button class="delete-btn" onclick="eliminarProveedor(${proveedor.id})">
                                <i class="zmdi zmdi-delete"></i> Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error al cargar proveedores:', error);
                swal({
                    title: 'Error',
                    text: 'No se pudieron cargar los proveedores: ' + error.message,
                    type: 'error',
                    confirmButtonText: 'Aceptar'
                });
            });
    }

    // Función para editar un proveedor
    function editarProveedor(proveedor) {
        // Rellenar el formulario con los datos del proveedor
        document.getElementById('id').value = proveedor.id;
        document.getElementById('nombre').value = proveedor.nombre;
        document.getElementById('direccion').value = proveedor.direccion;
        document.getElementById('cp').value = proveedor.cp;
        document.getElementById('poblacion').value = proveedor.poblacion;
        document.getElementById('provincia').value = proveedor.provincia;
        document.getElementById('nif').value = proveedor.nif;
        document.getElementById('telefono').value = proveedor.telefono;
        document.getElementById('fax').value = proveedor.fax || '';
        document.getElementById('www').value = proveedor.www || '';
        document.getElementById('correo_e').value = proveedor.correo_e;

        // Cambiar a la pestaña de edición
        document.querySelector('.mdl-tabs__tab-bar a[href="#tabNewAdmin"]').click();

        // Actualizar los campos del Material Design Lite
        document.querySelectorAll('.mdl-textfield').forEach(function(field) {
            field.classList.add('is-dirty');
        });
    }

    // Función para eliminar un proveedor
    function eliminarProveedor(id) {
        swal({
            title: "¿Está seguro?",
            text: "Esta acción eliminará el proveedor permanentemente",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
            closeOnConfirm: false
        }, function(isConfirm) {
            if (isConfirm) {
                fetch('eliminar_proveedor.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        swal("¡Eliminado!", data.message, "success");
                        cargarProveedores();
                    } else {
                        swal("Error", data.message, "error");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    swal("Error", "Ocurrió un error al eliminar el proveedor", "error");
                });
            }
        });
    }

    // Manejar el envío del formulario (crear o actualizar)
    document.getElementById('provider-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            id: document.getElementById('id').value,
            nombre: document.getElementById('nombre').value,
            direccion: document.getElementById('direccion').value,
            cp: document.getElementById('cp').value,
            poblacion: document.getElementById('poblacion').value,
            provincia: document.getElementById('provincia').value,
            nif: document.getElementById('nif').value,
            telefono: document.getElementById('telefono').value,
            fax: document.getElementById('fax').value,
            www: document.getElementById('www').value,
            correo_e: document.getElementById('correo_e').value
        };

        // Determinar si es una creación o actualización
        const isEditing = formData.id !== '';
        const url = isEditing ? 'modificar_proveedor.php' : 'guardar_proveedor.php';
        const successMessage = isEditing ? 'Proveedor actualizado correctamente' : 'Proveedor guardado correctamente';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                swal({
                    title: "¡Éxito!",
                    text: successMessage,
                    type: "success",
                    timer: 2000,
                    showConfirmButton: false
                });
                // Limpiar el formulario
                document.getElementById('provider-form').reset();
                document.getElementById('id').value = '';
                // Refrescar la lista de proveedores
                cargarProveedores();
                // Si estamos editando, cambiar a la pestaña de lista
                if (isEditing) {
                    setTimeout(() => {
                        document.querySelector('.mdl-tabs__tab-bar a[href="#tabListAdmin"]').click();
                    }, 2100);
                }
            } else {
                swal("Error", data.message, "error");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            swal("Error", "Ocurrió un error al procesar la solicitud", "error");
        });
    });
</script>

</html>